// =============================================================================
// App.tsx — Корневой компонент приложения
// =============================================================================
// Здесь настраивается:
//   1. React Router — навигация между страницами
//   2. TanStack Query — управление серверным состоянием
//   3. Глобальная структура приложения
//
// Архитектура:
//   App.tsx
//   ├── QueryClientProvider (TanStack Query)
//   │   └── BrowserRouter (React Router)
//   │       └── Routes
//   │           └── Layout (общая обёртка)
//   │               ├── Dashboard (/)
//   │               ├── Projects (/projects)
//   │               └── Tasks (/tasks)
// =============================================================================

// -----------------------------------------------------------------------------
// Импорты: React Router
// -----------------------------------------------------------------------------
import { BrowserRouter, Routes, Route } from 'react-router-dom';
// BrowserRouter — использует HTML5 History API для навигации
// Routes — контейнер для маршрутов
// Route — определение отдельного маршрута (путь -> компонент)

// -----------------------------------------------------------------------------
// Импорты: TanStack Query (React Query)
// -----------------------------------------------------------------------------
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
// QueryClient — менеджер кэша и запросов
// QueryClientProvider — React контекст для доступа к QueryClient

// -----------------------------------------------------------------------------
// Импорты: Страницы
// -----------------------------------------------------------------------------
import { Layout } from '@/components/layout/Layout';
import { Dashboard } from '@/pages/Dashboard';
import { Projects } from '@/pages/Projects';
import { Tasks } from '@/pages/Tasks';

// =============================================================================
// Конфигурация TanStack Query
// =============================================================================
// QueryClient — это "мозг" React Query:
//   - Хранит кэш всех запросов
//   - Управляет состоянием (loading, error, success)
//   - Автоматически обновляет данные
//
// defaultOptions — настройки по умолчанию для всех запросов:
//   - staleTime: время после которого данные считаются "устаревшими"
//   - gcTime: время жизни кэша после отключения компонента
//   - retry: сколько раз повторять неудачный запрос
//   - refetchOnWindowFocus: обновлять ли данные при возврате на вкладку
// =============================================================================
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      // Данные считаются свежими 5 минут
      // (не будут рефетчиться автоматически в это время)
      staleTime: 5 * 60 * 1000,  // 5 минут в миллисекундах

      // Кэш живёт 30 минут после отмонтирования компонента
      gcTime: 30 * 60 * 1000,  // 30 минут

      // Повторять неудачные запросы 1 раз
      retry: 1,

      // Не рефетчить при возврате на вкладку (для простоты)
      refetchOnWindowFocus: false,
    },
  },
});

// =============================================================================
// Главный компонент приложения
// =============================================================================
function App() {
  return (
    // -------------------------------------------------------------------------
    // QueryClientProvider
    // -------------------------------------------------------------------------
    // Оборачивает всё приложение и предоставляет доступ к QueryClient
    // через React Context. Все компоненты внутри могут использовать
    // хуки useQuery, useMutation и т.д.
    // -------------------------------------------------------------------------
    <QueryClientProvider client={queryClient}>
      {/* -----------------------------------------------------------------------
       * BrowserRouter
       * -----------------------------------------------------------------------
       * Включает роутинг в приложении. Использует browser History API:
       *   - /           → Dashboard
       *   - /projects   → Projects
       *   - /tasks      → Tasks
       *
       * Альтернативы:
       *   - HashRouter — использует # в URL (для статичного хостинга)
       *   - MemoryRouter — для тестов (URL в памяти)
       * ----------------------------------------------------------------------- */}
      <BrowserRouter>
        {/* ---------------------------------------------------------------------
         * Routes — контейнер всех маршрутов
         * React Router ищет первый подходящий Route и рендерит его
         * --------------------------------------------------------------------- */}
        <Routes>
          {/* -------------------------------------------------------------------
           * Layout route — вложенные маршруты
           * -------------------------------------------------------------------
           * Layout рендерит <Outlet /> куда подставляются дочерние роуты.
           * Это позволяет иметь общую шапку и навигацию на всех страницах.
           *
           * path="/" — Layout начинается с корня
           * element={<Layout />} — компонент Layout
           *
           * Дочерние Route автоматически вложены внутрь:
           *   <Layout>
           *     <Outlet />  ← сюда подставится Dashboard/Projects/Tasks
           *   </Layout>
           * ------------------------------------------------------------------- */}
          <Route path="/" element={<Layout />}>
            {/* -----------------------------------------------------------------
             * index — маршрут по умолчанию для родительского пути
             * Когда URL = "/" рендерится Dashboard
             * ----------------------------------------------------------------- */}
            <Route index element={<Dashboard />} />

            {/* -----------------------------------------------------------------
             * /projects — страница проектов
             * ----------------------------------------------------------------- */}
            <Route path="projects" element={<Projects />} />

            {/* -----------------------------------------------------------------
             * /tasks — страница задач
             * ----------------------------------------------------------------- */}
            <Route path="tasks" element={<Tasks />} />

            {/* -----------------------------------------------------------------
             * 404 — страница не найдена
             * path="*" — ловит все несуществующие маршруты
             * ----------------------------------------------------------------- */}
            <Route path="*" element={<NotFound />} />
          </Route>
        </Routes>
      </BrowserRouter>
    </QueryClientProvider>
  );
}

// =============================================================================
// Компонент 404 — Страница не найдена
// =============================================================================
function NotFound() {
  return (
    <div className="text-center py-20">
      <h1 className="text-4xl font-bold text-gray-900 mb-4">404</h1>
      <p className="text-gray-500 mb-8">Страница не найдена</p>
      <a href="/" className="text-primary hover:underline">
        Вернуться на главную
      </a>
    </div>
  );
}

export default App;
